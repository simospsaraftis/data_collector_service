#
config
<match debug.*>
  @type stdout
</match>

#=========================================================================#
# block kodika pou: 
# 1) dilonei apo pou tha diavazei to fluentd logs diaforon programaton, 
# diladi statistika tou mixanimatos meso tou path
# 2) meso tou module @type tail tou leei na kanei tail sto path
# 3) meso tou tag tou leei na vaftisei tin pigi me to tag "stats.node"
# ayta pou diavazei to fluentd metatrepontai se json
# to pos_file einai to arxeio pou tha dimiourgithei mesa ston katalogo
# /tmp gia na gnorizei to fluentd pou itan tin proigoumeni fora pou diavase
#=========================================================================#
<source>
  @type tail

  path /var/log/*.log
  path_key tailed_path

  tag stats.node

  # parse json
  <parse>
    @type json
  </parse>
  
  pos_file /tmp/fluentd--1605454018.pos
</source>
#=========================================================================#

#=========================================================================#
# block kodika pou:
# 1) diloni apo pou tha diavazei to fluentd plirofories pou o xristis 
# apothikeyei kai oi opoies thelei na metaferthoun, meso tou path
# Epeidi exei asteriskous to fluentd tha diavasei oti ginetai mesa ston
# katalogo log-in
# 2) meso tou module @type tail tou leei na kanei tail sto path
# 3) meso tou tag tou leei na vaftisei tin pigi me to tag "log.node"
# den metatrepei ayta pou to fluentd diavazei se allo typo arxeiou
# to pos_file einai to arxeio pou tha dimiourgithei mesa ston katalogo
# /tmp gia na gnorizei to fluentd pou itan tin proigoumeni fora
#=========================================================================#
<source>
  @type tail

  path /var/log-in/*/*
  path_key tailed_path

  tag log.node

  # parse none
  <parse>
    @type none
  </parse>

  pos_file /tmp/fluentd--1605454014.pos
</source>


#=======================================================================#
# Orizoume ti tha kanoume me ayta pou diavasame
# Otan tha symvei kati me tag "log", to fluentd tha to kanei copy
# kai ta to apothikeysei sti vasi
# Xrisimopoieitai to module mongo_replset pou exei sxesi me ti MongoDB
# Dilonoume oti theloume na syndethei sti vasi "app_swarmlab"
# Otan tha syndethei sti vasi tha parei to collection "logs"
# Dilonoume tous server me to nodes
# Dilonoume to username, to password kai epeidi exoume replica_set, to
# dilonoume kai ayto, gia na mporesoume na syndethoume sti vasi
# Ean paei kati strava tou leme na xanaprospathisei se 60 deyterolepta
# Kathe 20 deyterolepta, to fluentd tha sozei ta dedomena sti vasi
#=======================================================================#
<match log.*>
  @type copy
  <store>
          @type mongo_replset

          database app_swarmlab
          collection logs
          nodes swarmlabmongo1:27017,swarmlabmongo2:27017,swarmlabmongo3:27017

          user app_swarmlab
          password app_swarmlab

          replica_set rs0
          num_retries 60
          capped
          capped_size 100m


          <buffer>
            flush_interval 20s
          </buffer>
  </store>
#  <store>
#        @type stdout
#  </store>

#=======================================================================#
# Block kodika gia tin onEvent topiki/prosorini apothikeysi ton dedomenon
#=======================================================================#
#  <store>
#	  @type file
#	  path /tmp/mylog
#	  <buffer>
#	    timekey 1d
#	    timekey_use_utc true
#	    timekey_wait 10s
#	  </buffer>
#  </store>


</match>

#=======================================================================#
# Orizoume ti tha kanoume me ayta pou diavasame
# Otan tha symvei kati me tag "stats", to fluentd tha to kanei copy
# kai ta to apothikeysei sti vasi
# Xrisimopoieitai to module mongo_replset pou exei sxesi me ti MongoDB
# Dilonoume oti theloume na syndethei sti vasi "app_swarmlab"
# Otan tha syndethei sti vasi tha parei to collection "logs"
# Dilonoume tous server me to nodes
# Dilonoume to username, to password kai epeidi exoume replica_set, to
# dilonoume kai ayto, gia na mporesoume na syndethoume sti vasi
# Ean paei kati strava tou leme na xanaprospathisei se 60 deyterolepta
# Kathe 20 deyterolepta, to fluentd tha sozei ta dedomena sti vasi
#=======================================================================#
<match stats.*>
  @type copy
  <store>
          @type mongo_replset

          database app_swarmlab
          collection logs
          nodes swarmlabmongo1:27017,swarmlabmongo2:27017,swarmlabmongo3:27017

          user swarmlab
          password swarmlab

          replica_set rs0
          num_retries 60
          capped
          capped_size 100m
  </store>
#  <store>
#       @type stdout
#  </store>
</match>
